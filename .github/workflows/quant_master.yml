name: Quant Intelligence Master

on:
  schedule:
    # 1. æ¯å°æ™‚æ•´é»åŸ·è¡Œ (å°åŒ—æ™‚é–“å„æ•´é»)
    - cron: '0 * * * *'
    # 2. é¡å¤–å¢åŠ ï¼šå°è‚¡é–‹ç›¤å‰é—œéµæ¶ˆæ¯ (å°åŒ— 08:30 -> UTC 00:30)
    - cron: '30 00 * * 1-5'
    # 3. å°è‚¡ç›¤å¾Œ AI åˆ†æ (å°åŒ— 15:30) -> UTC 07:30
    - cron: '30 07 * * 1-5'
    # 4. ç¾è‚¡ç›¤å¾Œ AI åˆ†æ (å°åŒ— 06:00) -> UTC 22:00
    - cron: '00 22 * * 1-5'

  workflow_dispatch:

jobs:
  quant_tasks:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Execute Task
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          NEWS_WEBHOOK_URL: ${{ secrets.NEWS_WEBHOOK_URL }}
        run: |
          # å¼·åˆ¶è¨­å®šæ™‚å€ä¸¦ç²å–æ™‚é–“
          export TZ="Asia/Taipei"
          HOUR=$(date +%H)
          MINUTE=$(date +%M)
          DAY_OF_WEEK=$(date +%u)

          echo "ç›®å‰åŸ·è¡Œæ™‚é–“ (å°åŒ—): $HOUR:$MINUTE, æ˜ŸæœŸ: $DAY_OF_WEEK"

          # --- ä»»å‹™ 1ï¼šæ–°èé›·é” ---
          # åªè¦æ˜¯æ•´é» (0~10åˆ†) æˆ– å°åŒ— 08:30 (30~40åˆ†) æˆ–è€…æ˜¯æ‰‹å‹•åŸ·è¡Œï¼Œå°±å•Ÿå‹•é›·é”
          if [ "$MINUTE" -le "10" ] || ([ "$HOUR" == "08" ] && [ "$MINUTE" -ge "30" ] && [ "$MINUTE" -le "40" ]) || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ğŸš€ åŸ·è¡Œæ–°èé›·é” (å«å€‹è‚¡åµæ¸¬èˆ‡å ±åƒ¹)..."
            python scripts/news_radar.py
          fi

          # --- ä»»å‹™ 2ï¼šAI åˆ†æ (åªæœ‰å¹³æ—¥è·‘) ---
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ğŸ› ï¸ æ‰‹å‹•è§¸ç™¼ï¼šåŸ·è¡Œ AI é æ¸¬å ±å‘Š..."
            python scripts/ai_tw_post.py
            python scripts/ai_us_post.py
          else
            if [ "$DAY_OF_WEEK" -le 5 ]; then
              # å°è‚¡ç›¤å¾Œå ±å‘Š
              if [ "$HOUR" == "15" ] && [ "$MINUTE" -ge "30" ] && [ "$MINUTE" -le "40" ]; then
                python scripts/ai_tw_post.py
              # ç¾è‚¡æ”¶ç›¤å ±å‘Š
              elif [ "$HOUR" == "06" ] && [ "$MINUTE" -le "10" ]; then
                python scripts/ai_us_post.py
              fi
            fi
          fi

      - name: Auto Sync Data back to GitHub
        if: always()
        run: |
          git config --local user.name "Quant-Master-Bot"
          git config --local user.email "actions@github.com"
          git add data/*.csv data/*.json data/*.txt || true
          
          # æ‹‰å–æœ€æ–°è®Šæ›´ï¼Œé¿å…èˆ‡å…¶ä»–ä¸¦è¡Œä»»å‹™è¡çª
          git pull --rebase --autostash origin main
          
          if ! git diff --cached --quiet; then
            git commit -m "Auto-update: Market Data & News Cache [skip ci]"
            git push origin main
          else
            echo "ç„¡æ•¸æ“šæ›´æ–°ï¼Œè·³éæäº¤ã€‚"
          fi
