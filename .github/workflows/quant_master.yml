name: Quant Intelligence Master

on:
  schedule:
    # 1. 台股開盤前 30 分 (台北 08:30) -> UTC 00:30
    - cron: '30 00 * * 1-5'
    
    # 2. 美股開盤前 30 分 (台北 21:00) -> UTC 13:00
    # 註：若冬令時間開盤為 22:30，可視需求改為 '00 14' (台北 22:00)
    - cron: '00 13 * * 1-5'
    
  workflow_dispatch: 

jobs:
  quant_tasks:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Execute Task
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          NEWS_WEBHOOK_URL: ${{ secrets.NEWS_WEBHOOK_URL }}
        run: |
          HOUR=$(date +%H)
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # 手動執行：全部跑一遍
            python scripts/news_radar.py
            python scripts/ai_tw_post.py
            python scripts/ai_us_post.py
          else
            # 依據時間自動判斷執行對象
            if [ "$HOUR" == "00" ]; then
              # --- 台北 08:30：台股盤前 ---
              python scripts/news_radar.py
              python scripts/ai_tw_post.py
              
            elif [ "$HOUR" == "13" ]; then
              # --- 台北 21:00：美股盤前 ---
              python scripts/news_radar.py
              python scripts/ai_us_post.py
            fi
          fi

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/*.csv
          git commit -m "Update history data [skip ci]" || exit 0
          git push
