name: Quant Intelligence Master

on:
  schedule:
    # 1. æ–°èé›·é”ï¼šæ¯å°æ™‚æ•´é»è§¸ç™¼ (å°åŒ—æ™‚é–“å„æ•´é»)
    - cron: '0 * * * *'
    # 2. å°è‚¡ç›¤å¾Œ AI åˆ†æ (å°åŒ— 15:30) -> UTC 07:30
    - cron: '30 07 * * 1-5'
    # 3. ç¾è‚¡ç›¤å¾Œ AI åˆ†æ (å°åŒ— 06:00) -> UTC 22:00
    - cron: '00 22 * * 1-5'

  workflow_dispatch:

jobs:
  quant_tasks:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Execute Task
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          NEWS_WEBHOOK_URL: ${{ secrets.NEWS_WEBHOOK_URL }}
          TZ: Asia/Taipei # å¼·åˆ¶ä½¿ç”¨å°åŒ—æ™‚å€
        run: |
          HOUR=$(date +%H)
          MINUTE=$(date +%M)
          DAY_OF_WEEK=$(date +%u)

          echo "ç›®å‰åŸ·è¡Œæ™‚é–“ (å°åŒ—): $HOUR:$MINUTE, æ˜ŸæœŸ: $DAY_OF_WEEK"

          # --- ä»»å‹™ 1ï¼šæ–°èé›·é” (æ•´é»åŸ·è¡Œ) ---
          # ä¿®æ­£ï¼šæ”¾å¯¬åˆ†é˜åˆ¤å®šè‡³å‰ 10 åˆ†é˜ï¼Œé¿å… GitHub å»¶é²å•Ÿå‹•å°è‡´å¤±æ•ˆ
          if [ "$MINUTE" -le "10" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ğŸš€ åŸ·è¡Œæ–°èé›·é”ä»»å‹™..."
            python scripts/news_radar.py
          fi

          # --- ä»»å‹™ 2ï¼šAI åˆ†æ (ç‰¹å®šæ™‚é–“åŸ·è¡Œ) ---
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ğŸ› ï¸ æ‰‹å‹•è§¸ç™¼ï¼šåŸ·è¡Œå°ç¾é›™å¸‚æ‰€æœ‰åˆ†æ..."
            python scripts/ai_tw_post.py
            python scripts/ai_us_post.py
          else
            if [ "$DAY_OF_WEEK" -le 5 ]; then
              # å°è‚¡ 15:30 (å…è¨± 15:30~15:40 åŸ·è¡Œ)
              if [ "$HOUR" == "15" ] && [ "$MINUTE" -ge "30" ] && [ "$MINUTE" -le "40" ]; then
                echo "ğŸ“ˆ åŸ·è¡Œå°è‚¡ AI åˆ†æå ±å‘Š..."
                python scripts/ai_tw_post.py
              # ç¾è‚¡ 06:00 (å…è¨± 06:00~06:10 åŸ·è¡Œ)
              elif [ "$HOUR" == "06" ] && [ "$MINUTE" -le "10" ]; then
                echo "ğŸ“ˆ åŸ·è¡Œç¾è‚¡ AI åˆ†æå ±å‘Š..."
                python scripts/ai_us_post.py
              fi
            fi
          fi

      - name: Auto Sync Data back to GitHub
        if: always() # å³ä½¿åŸ·è¡Œå‡ºéŒ¯ä¹Ÿå˜—è©¦ä¿å­˜ç¾æœ‰çš„ç·©å­˜æª”æ¡ˆ
        run: |
          git config --local user.name "Quant-Master-Bot"
          git config --local user.email "actions@github.com"
          
          # é˜²æ­¢ Push è¡çªï¼šå…ˆæ‹‰å–ä¸¦åˆä½µé ç«¯è®Šæ›´
          git pull --rebase --autostash origin main
          
          # ç¢ºä¿ data ç›®éŒ„å…§çš„æ‰€æœ‰è®Šæ›´éƒ½è¢«è¿½è¹¤
          git add data/*.csv data/*.json data/*.txt || true
          
          if ! git diff --cached --quiet; then
            git commit -m "Auto-update: Market Data & News Cache [skip ci]"
            git push origin main
          else
            echo "ç„¡æ•¸æ“šæ›´æ–°ï¼Œè·³éæäº¤ã€‚"
          fi
